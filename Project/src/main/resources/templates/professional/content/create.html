<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <title>Criar Novo Conteúdo</title>
    
    <th:block layout:fragment="page-head">
        <style>
            .dynamic-item {
                position: relative;
                padding-right: 40px; 
            }
            .remove-btn {
                position: absolute;
                top: 50%;
                right: 0;
                transform: translateY(-50%);
                cursor: pointer;
                color: hsl(var(--destructive));
                font-weight: bold;
                padding: 4px 8px;
                background-color: hsl(var(--destructive) / 0.1);
                border-radius: 99px;
            }
            .remove-btn:hover {
                background-color: hsl(var(--destructive) / 0.2);
            }
            .remove-btn-top {
                 position: absolute;
                 top: 1.5rem; 
                 right: 1.5rem; 
                 transform: none;
            }
        </style>
    </th:block>
</head>

<main layout:fragment="content" class="pt-24 pb-12">
    <div class="container mx-auto px-4 max-w-3xl">

        <h1 class="text-4xl font-bold text-foreground mb-8">
            Criar <span class="bg-gradient-primary bg-clip-text text-transparent">Conteúdo</span>
        </h1>
        
        <div th:if="${error}" class="bg-destructive/10 text-destructive border border-destructive p-3 rounded-md mb-6 text-center">
            <p th:text="${error}"></p>
        </div>

        <!-- 
          MUDANÇA: 
          - Botão de submit movido para o final do form.
          - Placeholder "Selecione um tipo..." está DENTRO do 'content-specific-fields'
        -->
        <form th:action="@{/professional/content/create}" th:object="${contentDto}" method="post" 
              class="bg-card border border-border rounded-xl shadow-lg p-8 space-y-6">

            <!-- Campos Comuns -->
            <div>
                <label for="name" class="block text-sm font-medium text-muted-foreground mb-1">Título</label>
                <input type="text" id="name" th:field="*{name}" required
                       class="w-full p-3 rounded-md bg-background border border-border focus:border-primary focus:ring-1 focus:ring-primary transition-colors text-foreground"
                       placeholder="Título do conteúdo">
            </div>
            <div>
                <label for="description" class="block text-sm font-medium text-muted-foreground mb-1">Descrição</label>
                <textarea id="description" th:field="*{description}" rows="3"
                          class="w-full p-3 rounded-md bg-background border border-border focus:border-primary focus:ring-1 focus:ring-primary transition-colors text-foreground"
                          placeholder="Breve descrição do conteúdo"></textarea>
            </div>
            <div>
                <label for="contentType" class="block text-sm font-medium text-muted-foreground mb-1">Tipo de Conteúdo</label>
                <select id="contentType" th:field="*{contentType}" required
                        hx-get="@{/professional/content/fields-for-type}"
                        hx-target="#content-specific-fields"
                        hx-swap="innerHTML"
                        hx-trigger="change"
                        class="w-full p-3 rounded-md bg-background border border-border focus:border-primary focus:ring-1 focus:ring-primary transition-colors text-foreground">
                    <option value="">Selecione um tipo...</option>
                    <option th:each="type : ${contentTypes}" 
                            th:value="${type.name()}" 
                            th:text="${type.name()}">TIPO
                    </option>
                </select>
            </div>

            <!-- Container dos Campos Específicos (HTMX Target) -->
            <div id="content-specific-fields" class="space-y-6 pt-4 border-t border-border">
                <!-- 
                  MUDANÇA: 
                  - Placeholder movido para dentro do target.
                  - O fragmento 'emptyFields' foi criado para o caso de "Selecione..."
                -->
                <p class="text-muted-foreground text-center">Selecione um tipo de conteúdo para ver mais opções.</p>
            </div>
            
            <!-- 
              MUDANÇA: 
              - Botão de submit movido para o final do formulário.
            -->
            <button type="submit" 
                    class="w-full mt-6 px-4 py-3 rounded-md bg-primary hover:bg-primary/90 text-primary-foreground font-semibold shadow-glow-primary transition-colors">
                Criar Conteúdo
            </button>
            
        </form>
    </div>
    
    <!-- ====================================================================== -->
    <!-- FRAGMENTOS HTMX (Definidos no mesmo arquivo para o Thymeleaf encontrar) -->
    <!-- ====================================================================== -->
    
    <!-- Fragmento Vazio (para o placeholder) -->
    <div th:fragment="emptyFields" class="space-y-6 pt-4 border-t border-border">
         <p class="text-muted-foreground text-center">Selecione um tipo de conteúdo para ver mais opções.</p>
    </div>

    <!-- Fragmento para DIET -->
    <div th:fragment="dietFields" class="space-y-6 pt-4 border-t border-border">
        <div>
            <label for="mealsEspecifications" class="block text-sm font-medium text-muted-foreground mb-1">Plano Alimentar</label>
            <textarea id="mealsEspecifications" th:field="*{mealsEspecifications}" rows="10"
                      class="w-full p-3 rounded-md bg-background border border-border focus:border-primary focus:ring-1 focus:ring-primary transition-colors text-foreground"
                      placeholder="Descreva as refeições..."></textarea>
        </div>
    </div>

    <!-- 
      Fragmento para MATERIAL 
      MUDANÇA: 
      - Usa os enums 'allContentTags' e 'allContentBlockTypes' injetados pelo controller
    -->
    <div th:fragment="materialFields" class="space-y-6 pt-4 border-t border-border">
        <div>
            <label class="block text-sm font-medium text-muted-foreground mb-2">Tags</label>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 p-3 bg-background rounded-md border border-border">
                <div th:each="tag : ${allContentTags}" class="flex items-center gap-2">
                    <input type="checkbox" th:field="*{tags}" th:value="${tag.name()}" th:id="${'tag-' + tag.name()}"
                           class="h-4 w-4 rounded border-border text-primary focus:ring-primary">
                    <label th:for="${'tag-' + tag.name()}" class="text-sm text-foreground" th:text="${tag.name()}"></label>
                </div>
            </div>
        </div>
        
        <div class="border-t border-border pt-6">
            <h3 class="text-xl font-semibold text-foreground mb-4">Blocos de Conteúdo</h3>
            <div id="content-blocks-list" class="space-y-4">
                <!-- Blocos de conteúdo serão adicionados aqui -->
            </div>
            <button type="button" id="add-content-block-btn"
                    class="mt-4 inline-flex items-center justify-center px-4 py-2 h-9 rounded-md bg-accent hover:bg-accent/90 text-accent-foreground text-sm font-medium transition-colors">
                Adicionar Bloco
            </button>
        </div>
    </div>

    <!-- 
      Fragmento para ROUTINE 
      MUDANÇA: 
      - Usa os enums 'allRoutineLevels', 'allGoalTypes', 'allMuscleGroups', 'allTrainingTechniques'
    -->
    <div th:fragment="routineFields" class="space-y-6 pt-4 border-t border-border">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="level" class="block text-sm font-medium text-muted-foreground mb-1">Nível da Rotina</label>
                <select id="level" th:field="*{routineLevel}" class="w-full p-3 rounded-md bg-background border border-border focus:border-primary focus:ring-1 focus:ring-primary transition-colors text-foreground">
                    <option th:each="opt : ${allRoutineLevels}" th:value="${opt.name()}" th:text="${opt.name()}"></option>
                </select>
            </div>
            <div>
                <label for="goal" class="block text-sm font-medium text-muted-foreground mb-1">Objetivo Principal</label>
                <select id="goal" th:field="*{goals}" multiple class="w-full p-3 h-24 rounded-md bg-background border border-border focus:border-primary focus:ring-1 focus:ring-primary transition-colors text-foreground">
                    <option th:each="opt : ${allGoalTypes}" th:value="${opt.name()}" th:text="${opt.name()}"></option>
                </select>
            </div>
        </div>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="startDate" class="block text-sm font-medium text-muted-foreground mb-1">Data Início (Opcional)</label>
                <input type="date" id="startDate" th:field="*{startDate}"
                       class="w-full p-3 rounded-md bg-background border border-border focus:border-primary focus:ring-1 focus:ring-primary transition-colors text-foreground">
            </div>
            <div>
                <label for="endDate" class="block text-sm font-medium text-muted-foreground mb-1">Data Fim (Opcional)</label>
                <input type="date" id="endDate" th:field="*{endDate}"
                       class="w-full p-3 rounded-md bg-background border border-border focus:border-primary focus:ring-1 focus:ring-primary transition-colors text-foreground">
            </div>
        </div>

        <div class="border-t border-border pt-6">
            <h3 class="text-xl font-semibold text-foreground mb-4">Treinos</h3>
            <div id="trainings-list" class="space-y-6">
            </div>
            <button type="button" id="add-training-btn"
                    class="mt-4 inline-flex items-center justify-center px-4 py-2 h-9 rounded-md bg-accent hover:bg-accent/90 text-accent-foreground text-sm font-medium transition-colors">
                Adicionar Treino
            </button>
        </div>
    </div>
    
    <!-- 
      MUDANÇA:
      - Script atualizado para usar os enums injetados nos <select>
    -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        
        // Os Enums agora são nulos no início, eles só virão com os fragmentos HTMX
        let allExercises = /*[[${exercises}]]*/ null;
        let allTechniques = /*[[${allTrainingTechniques}]]*/ null;
        let allContentBlockTypes = /*[[${allContentBlockTypes}]]*/ null;
        let allMuscleGroups = /*[[${allMuscleGroups}]]*/ null;

        let trainingIdx = 0;
        let contentBlockIdx = 0;
        
        // === LÓGICA PARA BLOCOS DE CONTEÚDO (MATERIAL) ===
        function createContentBlockHtml(cIdx) {
            
            // Recarrega os enums (eles vêm do fragmento)
            if (!allContentBlockTypes) {
                allContentBlockTypes = /*[[${allContentBlockTypes}]]*/ [];
            }
            let blockTypeOptions = allContentBlockTypes.map(type => `<option value="${type}">${type}</option>`).join('');

            return `
            <div class="dynamic-item p-4 border border-border rounded-lg space-y-3 bg-background/50">
                <span class="remove-btn remove-btn-top" onclick="this.parentElement.remove()">X</span>
                <div>
                    <label class="text-xs font-medium text-muted-foreground">Tipo de Bloco</label>
                    <select name="contentBlocks[${cIdx}].type" class="w-full p-2 text-sm rounded-md bg-background border border-border">
                        ${blockTypeOptions}
                    </select>
                </div>
                <div>
                    <label class="text-xs font-medium text-muted-foreground">Conteúdo (Texto ou URL)</label>
                    <textarea name="contentBlocks[${cIdx}].value" rows="3" class="w-full p-2 text-sm rounded-md bg-background border border-border" placeholder="Insira o texto ou a URL..."></textarea>
                </div>
            </div>
            `;
        }

        // === LÓGICA PARA TREINOS E SÉRIES (ROTINA) ===
        function createExerciseSetHtml(tIdx, eIdx) {
            // Recarrega os enums (eles vêm do fragmento)
            if (!allExercises) allExercises = /*[[${exercises}]]*/ [];
            if (!allTechniques) allTechniques = /*[[${allTrainingTechniques}]]*/ [];

            let exOptions = allExercises.map(ex => `<option value="${ex.id}">${ex.name}</option>`).join('');
            let techOptions = '<option value="">Nenhuma</option>' + allTechniques.map(t => `<option value="${t}">${t}</option>`).join('');

            return `
            <div class="dynamic-item grid grid-cols-2 md:grid-cols-3 gap-3 p-3 bg-background/50 rounded-md border border-border">
                <div class="col-span-2 md:col-span-3">
                    <label class="text-xs font-medium text-muted-foreground">Exercício</label>
                    <select name="trainingDtos[${tIdx}].trainingSets[${eIdx}].exerciseId" class="w-full p-2 text-sm rounded-md bg-background border border-border">
                        ${exOptions}
                    </select>
                </div>
                <div>
                    <label class="text-xs font-medium text-muted-foreground">Séries</label>
                    <input type="number" name="trainingDtos[${tIdx}].trainingSets[${eIdx}].sets" class="w-full p-2 text-sm rounded-md bg-background border border-border" placeholder="Ex: 3">
                </div>
                <div>
                    <label class="text-xs font-medium text-muted-foreground">Reps</label>
                    <input type="text" name="trainingDtos[${tIdx}].trainingSets[${eIdx}].repetitions" class="w-full p-2 text-sm rounded-md bg-background border border-border" placeholder="Ex: 10-12">
                </div>
                <div>
                    <label class="text-xs font-medium text-muted-foreground">Descanso (s)</label>
                    <input type="number" name="trainingDtos[${tIdx}].trainingSets[${eIdx}].restTimeSeconds" class="w-full p-2 text-sm rounded-md bg-background border border-border" placeholder="Ex: 60">
                </div>
                <div class="col-span-2 md:col-span-3">
                    <label class="text-xs font-medium text-muted-foreground">Técnica</label>
                    <select name="trainingDtos[${tIdx}].trainingSets[${eIdx}].technique" class="w-full p-2 text-sm rounded-md bg-background border border-border">
                        ${techOptions}
                    </select>
                </div>
                <div>
                    <label class="text-xs font-medium text-muted-foreground">Carga (Kg)</label>
                    <input type="number" step="0.5" name="trainingDtos[${tIdx}].trainingSets[${eIdx}].loadInKg" class="w-full p-2 text-sm rounded-md bg-background border border-border" placeholder="Opcional">
                </div>
                <div>
                    <label class="text-xs font-medium text-muted-foreground">Duração (s)</label>
                    <input type="number" name="trainingDtos[${tIdx}].trainingSets[${eIdx}].durationSeconds" class="w-full p-2 text-sm rounded-md bg-background border border-border" placeholder="Opcional">
                </div>
                 
                <span class="remove-btn" onclick="this.parentElement.remove()">X</span>
            </div>
            `;
        }
        
        function createTrainingHtml(tIdx) {
            // Recarrega os enums (eles vêm do fragmento)
            if (!allMuscleGroups) allMuscleGroups = /*[[${allMuscleGroups}]]*/ [];
            
            let muscleGroupOptions = allMuscleGroups.map(mg => `<option value="${mg}">${mg}</option>`).join('');

            return `
            <div class="dynamic-item p-4 border border-border rounded-lg space-y-4 bg-background/30">
                <span class="remove-btn remove-btn-top" onclick="this.parentElement.remove()">X</span>
                <div>
                    <label class="block text-sm font-medium text-muted-foreground mb-1">Nome do Treino</label>
                    <input type="text" name="trainingDtos[${tIdx}].name" class="w-full p-3 rounded-md bg-background border border-border" placeholder="Ex: Treino A - Peito e Tríceps">
                </div>
                <div>
                     <label class="block text-sm font-medium text-muted-foreground mb-1">Grupos Musculares</label>
                     <select name="trainingDtos[${tIdx}].targetMuscleGroups" multiple class="w-full p-3 h-24 rounded-md bg-background border border-border">
                        ${muscleGroupOptions}
                     </select>
                </div>

                <div class="sets-list space-y-3 pt-3 border-t border-border">
                    <h4 class="text-sm font-semibold text-foreground">Exercícios/Sets</h4>
                </div>
                <button type="button" class="add-exercise-set-btn inline-flex items-center justify-center px-3 py-1.5 h-8 rounded-md bg-primary/10 text-primary text-sm font-medium transition-colors">
                    + Adicionar Exercício
                </button>
            </div>
            `;
        }

        // --- Event Listener Global ---
        document.body.addEventListener('click', function(e) {
            
            if (e.target && e.target.id === 'add-training-btn') {
                const trainingsList = document.getElementById('trainings-list');
                const newTraining = document.createElement('div');
                newTraining.innerHTML = createTrainingHtml(trainingIdx);
                trainingsList.appendChild(newTraining.firstElementChild);
                trainingIdx++;
            }
            
            if (e.target && e.target.classList.contains('add-exercise-set-btn')) {
                const setsList = e.target.previousElementSibling;
                const trainingItem = e.target.closest('.dynamic-item');
                const tIdx = Array.from(document.getElementById('trainings-list').children).indexOf(trainingItem);
                const eIdx = setsList.children.length -1; 
                
                const newExerciseSet = document.createElement('div');
                newExerciseSet.innerHTML = createExerciseSetHtml(tIdx, eIdx);
                setsList.appendChild(newExerciseSet.firstElementChild);
            }
            
            if (e.target && e.target.id === 'add-content-block-btn') {
                const blocksList = document.getElementById('content-blocks-list');
                const newBlock = document.createElement('div');
                newBlock.innerHTML = createContentBlockHtml(contentBlockIdx);
                blocksList.appendChild(newBlock.firstElementChild);
                contentBlockIdx++;
            }
        });
        
        /*]]>*/
    </script>
</main>
</html>